<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Item Database</title>
        <style>
            .item-card { border: 1px solid #ddd; padding: 10px; margin: 10px; width: 300px; }
            .item-card img { max-width: 50px; vertical-align: middle; }
        </style>
    </head>

    <body>
        <div>
            <label for="characterFilter">Filter by Character:</label>
            <select id="characterFilter">
                <option value="all">All</option>
                <option value="Badtz-maru">Badtz-maru</option>
                <!-- Add more character options here -->
            </select>
            <button onclick="filterItems()">Filter</button>
        </div>

        <div id="itemsContainer"></div>

        <script>
            let termImages = {};

            // Load term-image mappings from JSON
            async function loadTermImages() {
                termImages = await fetch('terms.json').then(res => res.json());
            }

            // Function to replace terms with images in any text
            function replaceTermsWithImages(text) {
                for (const term in termImages) {
                    // Match the term with the original case (this won't force lowercase)
                    const regex = new RegExp(`\\b${term}\\b`, "gi"); // Match whole words, case-insensitive

                    // Function to replace the matched term while keeping its original case
                    text = text.replace(regex, (match) => {
                        const imageTag = `<img src="${termImages[term]}" alt="${term}" style="width: 20px; vertical-align: middle;">`;
                        return imageTag + " " + match;
                    });
                }
                return text;
            }

            // Update displayed items with term images
            function displayItems(items) {
                const container = document.getElementById("itemsContainer");
                container.innerHTML = "";

                items.forEach(item => {
                    // Ensure character is an array, even if it's just a single value
                    let characterNames = Array.isArray(item.character) ? item.character : [item.character];  // Convert to array if it's not

                    characterNames = characterNames.join(", ");  // Join multiple characters if any

                    let sourceTextParts = item.source.split(" + ");
                    let sourceImages = item.images && item.images.source
                        ? (Array.isArray(item.images.source) 
                            ? sourceTextParts.map((text, index) => 
                                (item.images.source[index] ? `<img src="${item.images.source[index]}" alt="Source"> ` : "") + replaceTermsWithImages(text)
                            ).join(" + ") 
                            : `<img src="${item.images.source}" alt="Source"> ${replaceTermsWithImages(item.source)}`)
                        : replaceTermsWithImages(item.source); // Fallback if missing

                    container.innerHTML += `
                        <div class="item-card">
                            <h3>${item.images && item.images.item ? `<img src="${item.images.item}" alt="${item.item}">` : ""} ${replaceTermsWithImages(item.item)}</h3>
                            <p><strong>Character:</strong> ${characterNames}</p> <!-- Display character names as text -->
                            <p><strong>Value:</strong> ${item.value}</p>
                            <p><strong>Hearts:</strong> ${item.hearts}</p>
                            <p><strong>Source:</strong> ${sourceImages}</p>
                            <p><strong>Requirements:</strong> ${replaceTermsWithImages(item.requirements)}</p>
                            <p><strong>Comments:</strong> ${replaceTermsWithImages(item.comments)}</p>
                        </div>
                    `;
                });
            }

            // Function to filter items based on character selection
            function filterItems() {
                let selectedCharacter = document.getElementById("characterFilter").value;

                if (!database.length) {
                    console.error("Database is not loaded yet!");
                    return;
                }

                let filteredItems = selectedCharacter === "all"
                    ? database
                    : database.filter(item => item.character.includes(selectedCharacter));

                displayItems(filteredItems);
            }

            // Load term images first, then load database
            async function loadDatabase() {
                await loadTermImages();
                database = await fetch('data.json').then(res => res.json());
                displayItems(database);
            }

            loadDatabase();
        </script>
    </body>
</html>
